{% extends 'base.html' %}
{% block title %}Статистика{% endblock %}
{% block content %}
  <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Главная</a></li>
      <li class="breadcrumb-item"><a href="{% url 'defects:defect-list' %}">Дефекты</a></li>
      <li class="breadcrumb-item">Статистика</li>
    </ol>
  </nav>
  <figure class="text-center">
    <h3>Статистика</h3>
  </figure>
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <div class="row p-0">
        <canvas id="statisticsByYearChart"></canvas>
      </div>
      <div class="row p-0">
        <canvas id="statisticsByGroupChart"></canvas>
      </div>
      <div class="row p-0">
        <canvas id="statisticsByTechReasonChart"></canvas>
      </div>
      <div class="row p-0">
        <canvas id="statisticsByOrgReasonChart"></canvas>
      </div>
      <div class="row p-0">
        <canvas id="statisticsByReapairMethodChart"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function updateContent() {
      charts = {
        "{% url 'api:defect-statistics-by-year' %}": statisticsByYearChart,
        "{% url 'api:defect-statistics-by-group' %}": statisticsByGroupChart,
        "{% url 'api:defect-statistics-by-tech-reason' %}": statisticsByTechReasonChart,
        "{% url 'api:defect-statistics-by-org-reason' %}": statisticsByOrgReasonChart,
        "{% url 'api:defect-statistics-by-repair-method' %}": statisticsByReapairMethodChart,
      }
      Object.entries(charts).forEach(chart => updateStatistics(...chart));
    }

    function updateStatistics(url, chart) {
      fetch(url)
        .then(function(response) {
          return response.json()
        }).then(function(data) {
          data = formatStatisticsToArray(data);
          setStatistics(chart, data);
        }).catch(function(ex) {
          console.log('Error: ', ex)
        });
    }

    function formatStatisticsToArray(data) {
      let result = {};

      data.forEach(item => {
        Object.keys(data[0]).forEach(key => {
          if (result[key] != null && typeof(result[key] == 'object')) {
            result[key].push(item[key]);
          } else {
            result[key] = [];
          }
        });
      });

      return result
    }

    function setStatistics(chart, data) {
      chart.data.labels = data.label;
      chart.data.datasets[0].data = data.value;
      chart.update();
    }

    const lineChartConfig = {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Количество дефектов, шт.',
          data: [],
          backgroundColor: 'rgba(255, 159, 64, 0.2)',
          borderColor: 'rgba(255, 159, 64, 1)'
        }]
      },
      options: {
        elements: {
          bar: {
            borderWidth: 1,
          }
        },
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
                boxHeight: 0,
            }
          }
        }
      }
    };

    const barChartConfig = {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
            label: 'Количество дефектов, шт.',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)'
        }]
      },
      options: {
        indexAxis: 'y',
        elements: {
          bar: {
            borderWidth: 1,
          }
        },
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
                boxHeight: 0,
            }
          }
        }
      },
    };

    const statisticsByYearCtx = document.getElementById("statisticsByYearChart").getContext("2d");
    const statisticsByYearChart = new Chart(statisticsByYearCtx, lineChartConfig);

    const statisticsByGroupCtx = document.getElementById("statisticsByGroupChart").getContext("2d");
    const statisticsByGroupChart = new Chart(statisticsByGroupCtx, barChartConfig);

    const statisticsByTechReasonCtx = document.getElementById("statisticsByTechReasonChart").getContext("2d");
    const statisticsByTechReasonChart = new Chart(statisticsByTechReasonCtx, barChartConfig);

    const statisticsByOrgReasonCtx = document.getElementById("statisticsByOrgReasonChart").getContext("2d");
    const statisticsByOrgReasonChart = new Chart(statisticsByOrgReasonCtx, barChartConfig);

    const statisticsByReapairMethodCtx = document.getElementById("statisticsByReapairMethodChart").getContext("2d");
    const statisticsByReapairMethodChart = new Chart(statisticsByReapairMethodCtx, barChartConfig);

    updateContent()
  </script>
{% endblock %}
