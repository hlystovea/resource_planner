<div class="row justify-content-end">
    <div class="col-sm-2">
        <select class="form-select form-select-sm" id="selectFacility" name="facility"
            onchange="updateSelectConnection()">
            <option value="" selected>Объект...</option>
        </select>
    </div>
    <div class="col-sm-2">
        <select class="form-select form-select-sm" id="selectConnection" name="connection">
            <option value="" selected>Присоединение...</option>
        </select>
    </div>
    <div class="col-sm-2">
        <select class="form-select form-select-sm" id="selectGroup" name="group"
            hx-get="{% url 'hardware:group-select' %}"
            hx-trigger="load"
            hx-swap="beforeend"
            hx-params="none"
        >
            <option value="" selected>Группа оборудования...</option>
        </select>
    </div>
    <div class="col-sm-2">
        <select class="form-select form-select-sm" id="selectStatus" name="status">
            <option value="" selected>Статус...</option>
            <option value="false">Устранено</option>
            <option value="true">Не устранено</option>
        </select>
    </div>
    <div class="col-auto">
        <button id="updateButton" type="button" class="btn btn-secondary btn-sm mb-3"
            onclick="redirectPage()">Показать</button>
    </div>
</div>
<div class="row">
    <div class="col-auto" id="yearLinks">
    </div>
</div>
<script>
    const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
    });

    function redirectPage(year = null) {
        let searchParams = new URLSearchParams(window.location.search);
        let selectedYear = document.getElementById('selectedYear')
        let param_values = {
            'year': year != null ? year : (selectedYear ? selectedYear.innerText : ''),
            'facility': document.getElementById('selectFacility').value,
            'connection': document.getElementById('selectConnection').value,
            'group': document.getElementById('selectGroup').value,
            'unrepaired': document.getElementById('selectStatus').value,
        }
        Object.entries(param_values).forEach(([param, value]) => {
            (value === false || value) ? searchParams.set(param, value) : searchParams.delete(param);
        })
        window.location.search = searchParams.toString();
    };

    function createOptionElement(value, text, selected = false) {
        let option = document.createElement('option');
        option.value = value;
        option.innerText = text;
        option.selected = (selected) ? true : false;
        return option
    };

    function updateSelectOptions(id, url, selectedValue = '', firstOption = 'Выбрать..', key = 'abbreviation') {
        fetch(url)
            .then(function (response) {
                return response.json()
            }).then(function (data) {
                let parent = document.getElementById(id);
                let options = [];
                options.push(createOptionElement('', firstOption, true))
                data.forEach(obj => {
                    let selected = obj.id == selectedValue;
                    options.push(createOptionElement(obj.id, obj[key], selected));
                });
                parent.replaceChildren(...options);
            }).catch(function (ex) {
                console.log('Error: ', ex)
            });
    };

    function updateSelectFacility() {
        let id = "selectFacility"
        let url = "{% url 'api:facility-list' %}"
        let selectedValue = params.facility
        let firstOption = "Объект..."
        updateSelectOptions(id, url, selectedValue, firstOption);
    };

    function updateSelectGroup() {
        let id = "selectGroup"
        let url = "{% url 'api:group-list' %}"
        let selectedValue = params.group
        let firstOption = "Группа оборудования..."
        updateSelectOptions(id, url, selectedValue, firstOption, "name");
    };

    function updateSelectConnection() {
        let id = "selectConnection"
        let url = "{% url 'api:connection-list' %}"
        let facility = document.getElementById("selectFacility").value;
        if (facility) url = "{% url 'api:facility-list' %}" + facility + "/connections";
        let selectedValue = params.connection
        let firstOption = "Присоединение..."
        updateSelectOptions(id, url, selectedValue, firstOption, "facility_with_abbreviation");
    };

    function createLinkElement(value, color = "secondary") {
        let link = document.createElement("a");
        link.innerText = value;
        link.href = "#";
        link.className = "text-decoration-none link-" + color;
        if (color == "dark") {
            link.id = "selectedYear";
            link.className += " bg-warning";
        }
        link.addEventListener("click", () => redirectPage((color == 'dark') ? '' : value));
        return link
    };

    function updateYearLinks() {
        fetch("{% url 'api:defect-years' %}")
            .then(function (response) {
                return response.json()
            }).then(function (data) {
                let parent = document.getElementById("yearLinks");
                let links = [];
                links.push("Год: ")
                data.years.forEach(year => {
                    let color = (year == params.year) ? "dark" : "secondary";
                    links.push(createLinkElement(year, color));
                    links.push(" ")
                });
                parent.replaceChildren(...links);
            }).catch(function (ex) {
                console.log('Error: ', ex)
            });
    };

    updateYearLinks();
    updateSelectFacility();
    updateSelectConnection();
    // updateSelectGroup();
</script>